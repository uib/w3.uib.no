#!/bin/bash

# This script runs upgrade process starts, right after the sources has been
# switched to the new release.  It can be used to prepare for the upgrade
# process; for instance for enabling modules that must be present before
# we start.

REL=77

if git tag | grep -q R$REL; then
    echo "Disabled after $REL has been released";
    exit 1
fi

set -x
echo "Pre upgrade"
date +%FT%T

# Unset uib_content_list from the no-index array
bin/site-drush ev '
  $a=variable_get("uib_search_nodetype_noindex");
  unset($a[array_search("uib_content_list", $a)]);
  variable_set("uib_search_nodetype_noindex", $a);
'

# Updating elasticsearch by indexing content list nodes
a=$(bin/site-drush sqlq "select nid from node where type='uib_content_list' and status=1" | sed '1d')
for nid in $a; do bin/site-drush uib-search-node --index $nid >/dev/null ; done
