#!/bin/bash

# This script runs upgrade process starts, right after the sources has been
# switched to the new release.  It can be used to prepare for the upgrade
# process; for instance for enabling modules that must be present before
# we start.

REL=57

if git tag | grep -q R$REL; then
    echo "Disabled after $REL has been released";
    exit 1
fi

set -x
echo "Pre upgrade"
date +%FT%T

# make sure elasticsearch read-settings are correct:
curl -XPUT `bin/site-drush uib-search-url --admin`/_mapping/node --data \
'{"properties":{"w3":{"properties":{"published_timestamp":{"type":"date","format":"epoch_second"},"changed":{"type":"date","format":"epoch_second"}}}}}'
curl -XPUT `bin/site-drush uib-search-url --admin`/_mapping/study --data \
'{"properties":{"w3":{"properties":{"published_timestamp":{"type":"date","format":"epoch_second"},"changed":{"type":"date","format":"epoch_second"}}}}}'

curl -XPUT `bin/site-drush uib-search-url --admin`/_mapping/node --data \
'
{
  "properties": {
    "w3": {
      "properties": {
        "date": {
          "properties": {
            "value": {
              "type":   "date",
              "format": "yyyy-MM-dd HH:mm:ss"
            },
            "value2": {
              "type":   "date",
              "format": "yyyy-MM-dd HH:mm:ss"
            }
          }
        }
      }
    }
  }
}
'
curl -XPUT `bin/site-drush uib-search-url --admin`/_mapping/study --data \
'
{
  "properties": {
    "w3": {
      "properties": {
        "date": {
          "properties": {
            "value": {
              "type":   "date",
              "format": "yyyy-MM-dd HH:mm:ss"
            },
            "value2": {
              "type":   "date",
              "format": "yyyy-MM-dd HH:mm:ss"
            }
          }
        }
      }
    }
  }
}
'
curl -XPUT `bin/site-drush uib-search-url --admin`/_mapping/study --data \
'
{
  "properties": {
    "w3": {
      "properties": {
        "location": {
          "type": "string",
          "index": "not_analyzed"
        }
      }
    }
  }
}
'
curl -XPUT `bin/site-drush uib-search-url --admin`/_mapping/node --data \
'
{
  "properties": {
    "w3": {
      "properties": {
        "location": {
          "type": "string",
          "index": "not_analyzed"
        }
      }
    }
  }
}
'
