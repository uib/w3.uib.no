#!/bin/bash

# This script runs upgrade process starts, right after the sources has been
# switched to the new release.  It can be used to prepare for the upgrade
# process; for instance for enabling modules that must be present before
# we start.

REL=82

if git tag | grep -q R$REL; then
    echo "Disabled after $REL has been released";
    exit 1
fi

set -x
echo "Pre upgrade"
date +%FT%T

curl -XPUT `bin/site-drush uib-search-url --admin`_mapping/study --data \
'
{
  "properties": {
    "hits": {
      "properties": {
        "hits": {
          "type":   "integer"
        },
        "max_hits": {
          "type":   "integer"
        },
        "last_hit": {
          "type":   "date",
          "format": "epoch_second"
        }
      }
    }
  }
}
'
curl -XPUT `bin/site-drush uib-search-url --admin`_mapping/user --data \
'
{
  "properties": {
    "hits": {
      "properties": {
        "hits": {
          "type":   "integer"
        },
        "max_hits": {
          "type":   "integer"
        },
        "last_hit": {
          "type":   "date",
          "format": "epoch_second"
        }
      }
    }
  }
}
'
curl -XPUT `bin/site-drush uib-search-url --admin`_mapping/node --data \
'
{
  "properties": {
    "hits": {
      "properties": {
        "hits": {
          "type":   "integer"
        },
        "max_hits": {
          "type":   "integer"
        },
        "last_hit": {
          "type":   "date",
          "format": "epoch_second"
        }
      }
    }
  }
}
'
