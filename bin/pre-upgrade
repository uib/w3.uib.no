#!/bin/bash

# This script runs upgrade process starts, right after the sources has been
# switched to the new release.  It can be used to prepare for the upgrade
# process; for instance for enabling modules that must be present before
# we start.

REL=60

if git tag | grep -q R$REL; then
    echo "Disabled after $REL has been released";
    exit 1
fi

set -x
echo "Pre upgrade"
date +%FT%T

# update elasticsearch mapping:

curl -XPUT `bin/site-drush uib-search-url --admin`/_mapping/node --data \
'
{
  "properties": {
    "w3": {
      "properties": {
        "url_string": {
          "type": "string",
          "fields": {
            "nb": {
              "type": "string",
              "analyzer": "norwegian"
            },
            "en": {
              "type": "string",
              "analyzer": "english"
            }
          }
        }
      }
    }
  }
}
'
curl -XPUT `bin/site-drush uib-search-url --admin`/_mapping/study --data \
'
{
  "properties": {
    "w3": {
      "properties": {
        "url_string": {
          "type": "string",
          "fields": {
            "nb": {
              "type": "string",
              "analyzer": "norwegian"
            },
            "en": {
              "type": "string",
              "analyzer": "english"
            }
          }
        }
      }
    }
  }
}
'
