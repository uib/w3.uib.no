#!/bin/bash

# This script runs at the end of the upgrade process to the next release.
# It can be use to perform migrations or other manipulations of the content
# and configuration of the site.

if [ "$(hostname)" = attilatest.uib.no ]; then
    bin/site-drush vset uib_show_exam_info TRUE
    bin/site-drush scr uib-feature-areas.php
    if [ $(pwd) == '/var/www/w3.uib.no'  ] ;then
        bin/index-all-users
        bin/index-all-studies
        bin/index-all-nodes
    fi
fi


if [ $(pwd) == '/var/www/w3-prestaging.test.uib.no' ] ;then
    bin/site-drush scr uib-feature-areas.php
fi

REL=82

if git tag | grep -q R$REL; then
    echo "Disabled after $REL has been released";
    exit 1
fi

set -x

# Loop to prevent php timeout. Each loop handles 1000 nodes.
# This needs to be run manually after the release
# for i in `seq 0 1 120`; do
#   bin/site-drush scr node-update-image-caption
# done

# Indexing only content lists
bin/site-drush ev '$a = db_query("select nid from node where status=1 and type='"'"'uib_content_list'"'"'"); while($nid=$a->fetchField()){ echo "$nid\n"; node_save(node_load($nid));}'
