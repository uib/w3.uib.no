#!/bin/bash

# This script runs at the end of the upgrade process to the next release.
# It can be use to perform migrations or other manipulations of the content
# and configuration of the site.

if [ "$(hostname)" = attilatest.uib.no ]; then
    bin/site-drush vset uib_show_exam_info TRUE
    bin/index-all-users
    bin/index-all-studies
    bin/index-all-nodes
fi

REL=74

if git tag | grep -q R$REL; then
    echo "Disabled after $REL has been released";
    exit 1
fi

set -x

for i in {1..150}; do
  url=`bin/site-drush uib-search-url --admin`
  data=`curl -XGET "$url"'/node/_search?fields&q=w3.study_code:*&size=30'`
  php -r '$j=json_decode($argv[1]);echo "Ant feil: ".$j->hits->total;' "$data"
  ids=$(php -r '$j=json_decode($argv[1]);foreach($j->hits->hits as $h){echo $h->_id."\n";}; if($j->hits->total==0) echo "exit\n";' "$data")
  for f in $ids; do
    if [ "$f" == "exit" ]; then
      break 2
    fi;
    curl -s -XDELETE "$url"/node/$f
  done
done

bin/index-all-studies
