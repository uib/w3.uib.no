#!/bin/bash

# This script runs at the end of the upgrade process to the next release.
# It can be use to perform migrations or other manipulations of the content
# and configuration of the site.

if [ "$(hostname)" = attilatest.uib.no ]; then
    bin/site-drush vset uib_show_exam_info TRUE
    bin/index-all-users
    bin/index-all-studies
    bin/index-all-nodes
fi

REL=77

if git tag | grep -q R$REL; then
    echo "Disabled after $REL has been released";
    exit 1
fi

set -x

# Get nid's where manual boost is set to 10
ids="$(bin/site-drush sqlq --extra=-t 'select entity_id from field_data_field_uib_search_manual_boost where field_uib_search_manual_boost_value=10')"
for id in $ids; do
  # Set manual boost to 3 instead of 10
  bin/site-drush ev '$w=entity_metadata_wrapper("node",'$id'); $w->field_uib_search_manual_boost->set(3); $w->save();';
done

bin/site-drush uib-sync-fs
